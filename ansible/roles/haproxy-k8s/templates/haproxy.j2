global
        log /var/log/haproxy.log local0 info
        log-send-hostname
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 10s
        user haproxy
        group haproxy
        daemon
        maxconn 60000 # Don't increase it too much to avoid problems with FD Limit

        ssl-default-bind-ciphers PROFILE=SYSTEM
        ssl-default-server-ciphers PROFILE=SYSTEM

defaults
        log	global
        mode	http
        option	httplog
        option	dontlognull
        timeout connect 2s
        timeout client  1m
        timeout server  1m
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http

frontend kube-apiserver
        bind {{groups['haproxy_k8s'][0]}}:6443 # BIND to any address so it is accessible via VIP
        mode tcp
        option tcplog
        default_backend kube-apiserver

backend kube-apiserver
        balance roundrobin
        mode tcp
        option tcp-check
        server control-plane-1 {{groups['k8s_control_planes'][0]}}:6443 check
        server control-plane-2 {{groups['k8s_control_planes'][1]}}:6443 check
        server control-plane-3 {{groups['k8s_control_planes'][2]}}:6443 check


listen stats
        bind {{groups['haproxy_k8s'][0]}}:8443
        stats enable                    # enable statistics reports  
        stats hide-version              # Hide the version of HAProxy
        stats refresh 30s               # HAProxy refresh time
        stats show-node                 # Shows the hostname of the node
        stats auth haadmin:P@ssword     # Enforce Basic authentication for Stats page 
        stats uri /stats                # Statistics URL
